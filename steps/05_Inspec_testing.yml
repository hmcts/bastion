steps:

- powershell: |
    if (!(Test-Path -Path C:\Users\VSSADM~1\AppData\Local\Temp\inspec-*.msi)) {
    . { iwr -useb https://omnitruck.chef.io/install.ps1 } | iex; install -project inspec
    echo ($env:path).split(“;”)
    Get-ChildItem -path "C:\Opscode\inspec\bin" -Recurse
    }
  displayName: Inspec Setup

- task: qetza.replacetokens.replacetokens-task.replacetokens@3
  displayName: 'Replace tokens in **/*.*'
  inputs:
    targetFiles: '$(System.DefaultWorkingDirectory)/**/*.rb'
    tokenPrefix: '__'
    tokenSuffix: '__'

- task: AzurePowerShell@3
  displayName: 'Inspec Testing'
  inputs:
    azureSubscription: $(service_connection)
    ScriptType: InlineScript
    Inline: |
      $env:AZURE_CLIENT_ID=(Get-AzureKeyVaultSecret -VaultName "$(bastion_name)-kvs" -name "client-id").SecretValueText
      $env:AZURE_CLIENT_SECRET=(Get-AzureKeyVaultSecret -VaultName "$(bastion_name)-kvs" -name "client-secret").SecretValueText
      $env:AZURE_TENANT_ID=(Get-AzureKeyVaultSecret -VaultName "$(bastion_name)-kvs" -name "tenant-id").SecretValueText
      $env:AZURE_SUBSCRIPTION_ID=(Get-AzureKeyVaultSecret -VaultName "$(bastion_name)-kvs" -name "subscription-id").SecretValueText

      C:\\opscode\\inspec\\bin\\inspec.bat exec $(System.DefaultWorkingDirectory)/tests -t azure://
    azurePowerShellVersion: LatestVersion  
