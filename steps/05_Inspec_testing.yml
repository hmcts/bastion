steps:

- powershell: |
    if (!(Test-Path -Path C:\Users\VSSADM~1\AppData\Local\Temp\inspec-3.9.0-1-x64.msi)) {
    . { iwr -useb https://omnitruck.chef.io/install.ps1 } | iex; install -project inspec
    echo ($env:path).split(“;”)
    Get-ChildItem -path "C:\Opscode\inspec\bin" -Recurse
    }
  displayName: Inspec Setup

- task: qetza.replacetokens.replacetokens-task.replacetokens@3
  displayName: 'Replace tokens in **/*.*'
  inputs:
    targetFiles: '$(build.artifactstagingdirectory)/**/*.rb'
    tokenPrefix: '__'
    tokenSuffix: '__'

- task: AzureCLI@1
  displayName: 'Inspec Testing'
  inputs:
    azureSubscription: $(service_connection)
    scriptLocation: inlineScript
    inlineScript: |
      @echo off
      SET 
      SET /P AZURE_CLIENT_ID= | C:\windows\system32\cmd.exe /D /S /C ""C:\Program Files (x86)\Microsoft SDKs\Azure\CLI2\wbin\az.cmd" keyvault secret show --vault-name "rdo-uks-bastion-kvs" --name "client-id" --query value -o tsv"
      echo %AZURE_CLIENT_ID%
