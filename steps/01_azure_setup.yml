
steps:
- task: AzureKeyVault@1
  displayName: 'Azure Key Vault: $(bastion_name)-kvs'
  inputs:
    azureSubscription: $(service_connection)
    KeyVaultName: '$(bastion_name)-kvs'

- task: AzureCLI@1
  displayName: 'Create RG SA and Container'
  inputs:
    azureSubscription: $(service_connection)
    scriptLocation: inlineScript
    inlineScript: |
        call az group create --location $(bastion_location) --name $(bastion_rg)
        call az storage account create --name $(bastion_sa) --resource-group $(bastion_rg) --location $(bastion_location) --sku Standard_LRS
        call az storage container create --name $(bastion_name) --account-name $(bastion_sa)
 
- task: AzurePowerShell@3
  displayName: 'Get Storage Key'
  inputs:
    azureSubscription: $(service_connection)
    ScriptType: InlineScript
    Inline: |
     $key=(Get-AzureRmStorageAccountKey -ResourceGroupName $(bastion_rg) -AccountName $(bastion_sa)).Value[0]
     Write-Host "##vso[task.setvariable variable=bastion_sk]$key"
    azurePowerShellVersion: LatestVersion  

